services:
  ros2-gazebo:
    build:
      context: ./docker
      dockerfile: Dockerfile.linux
    image: cyberbrick-ros2:humble
    container_name: cyberbrick-ros2
    
    # X11 forwarding for native display
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - XDG_RUNTIME_DIR=/tmp/runtime-root
      # Set to 1 if you have GPU issues
      - LIBGL_ALWAYS_SOFTWARE=${LIBGL_ALWAYS_SOFTWARE:-0}
    
    volumes:
      # X11 socket for display
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # GPU access
      - /dev/dri:/dev/dri
      # Project files
      - ./launch:/ros2_ws/src/cyberbrick_description/launch
      - ./worlds:/ros2_ws/src/cyberbrick_description/worlds
      - ./scripts:/ros2_ws/src/cyberbrick_control/scripts
    
    privileged: true
    
    deploy:
      resources:
        limits:
          memory: 6G
    
    restart: unless-stopped

  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: mosquitto
    ports:
      - "1883:1883"
    command: mosquitto -c /mosquitto-no-auth.conf
    restart: unless-stopped
